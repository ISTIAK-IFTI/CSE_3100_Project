<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Department Dashboard - RUET Portal</title>

  <style>
    :root{
      --bg:#f5f6f8; --card:#fff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --dark:#111827;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial, sans-serif;background:var(--bg);color:var(--text)}
    .layout{display:flex;min-height:100vh}
    .sidebar{
      width:270px;background:var(--dark);color:#fff;padding:18px;position:sticky;top:0;height:100vh
    }
    .brand{font-weight:800;font-size:18px;line-height:1.2}
    .brand small{display:block;font-weight:400;opacity:.8;margin-top:4px}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:8px}
    .nav a{color:#e5e7eb;text-decoration:none;padding:10px 12px;border-radius:10px;display:block}
    .nav a.active,.nav a:hover{background:rgba(255,255,255,.12)}
    .spacer{flex:1}
    .logout{
      width:100%;border:none;border-radius:10px;padding:10px 12px;background:#ef4444;color:#fff;
      cursor:pointer;font-weight:900
    }

    .content{flex:1;padding:22px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title h1{margin:0;font-size:20px}
    .title p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .pill{
      background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:12px;color:var(--muted)
    }

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .card h2{margin:0 0 10px;font-size:14px}

    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .kv{padding:10px;border:1px solid var(--border);border-radius:12px}
    .kv .k{font-size:12px;color:var(--muted)}
    .kv .v{margin-top:4px;font-weight:900;font-size:18px}

    .form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select{
      width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;outline:none;background:#fff
    }
    input:focus,select:focus{border-color:#9ca3af}

    .row-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:1px solid var(--border);background:#fff;border-radius:10px;padding:9px 10px;
      cursor:pointer;font-weight:900;font-size:12px
    }
    .btn.primary{background:var(--dark);color:#fff;border-color:var(--dark)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:900}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .ok{background:#ecfdf5;border-color:#a7f3d0}
    .bad{background:#fef2f2;border-color:#fecaca}
    .muted{color:var(--muted);font-size:12px}

    .col-12{grid-column:span 12}
    .col-8{grid-column:span 8}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}

    @media (max-width: 980px){
      .sidebar{display:none}
      .kpi{grid-template-columns:1fr 1fr}
      .col-8,.col-4,.col-6{grid-column:span 12}
      .form-grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        RUET Portal
        <small>Department Dashboard</small>
      </div>

      <nav class="nav">
        <a class="active" href="department.html">Dashboard</a>
        <a href="#create">Create Fee</a>
        <a href="#fees">Fee List</a>
        <a href="#status">Payment Status</a>
      </nav>

      <div class="spacer"></div>
      <button class="logout" id="logoutBtn">Logout</button>
    </aside>

    <main class="content">
      <div class="topbar">
        <div class="title">
          <h1>Department Fee Management</h1>
          <p>Create departmental fees • Assign to students • Track payment status</p>
        </div>
        <div class="pill" id="modePill">Mode: —</div>
      </div>

      <section class="grid">
        <!-- Summary -->
        <div class="card col-12">
          <h2>Summary</h2>
          <div class="kpi">
            <div class="kv"><div class="k">Students (Demo)</div><div class="v" id="studentsCount">0</div></div>
            <div class="kv"><div class="k">Fees Created</div><div class="v" id="feesCount">0</div></div>
            <div class="kv"><div class="k">Unpaid Records</div><div class="v" id="unpaidCount">0</div></div>
            <div class="kv"><div class="k">Total Due (BDT)</div><div class="v" id="totalDue">0</div></div>
          </div>

          <div class="row-actions">
            <button class="btn" id="refreshBtn">Refresh</button>
            <span class="muted" id="statusText"></span>
          </div>
        </div>

        <!-- Create fee -->
        <div class="card col-6" id="create">
          <h2>Create Department Fee</h2>

          <div class="form-grid">
            <div>
              <label>Fee Type</label>
              <select id="feeType">
                <option value="Lab Fee">Lab Fee</option>
                <option value="Semester Fee">Semester Fee</option>
                <option value="Exam Fee">Exam Fee</option>
                <option value="Project Fee">Project Fee</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label>Semester / Period</label>
              <input id="feePeriod" placeholder="e.g., L-2 T-2 (Spring 2026)" />
            </div>
            <div>
              <label>Amount (BDT)</label>
              <input id="feeAmount" type="number" min="0" step="1" placeholder="e.g., 300" />
            </div>
            <div>
              <label>Deadline (optional)</label>
              <input id="feeDeadline" type="date" />
            </div>
          </div>

          <label style="margin-top:12px;">Assign to</label>
          <select id="assignMode">
            <option value="all">All Students (Demo)</option>
            <option value="session">By Session</option>
            <option value="ids">Specific Student IDs</option>
          </select>

          <div class="form-grid">
            <div>
              <label>Session (if selected)</label>
              <input id="assignSession" placeholder="e.g., 22" />
            </div>
            <div>
              <label>Student IDs (comma separated if selected)</label>
              <input id="assignIds" placeholder="e.g., 2203177, 2203188" />
            </div>
          </div>

          <div class="row-actions">
            <button class="btn primary" id="createFeeBtn">Create & Assign</button>
          </div>

          <p class="muted" style="margin-top:10px;">
            Later backend API: <code>POST /api/department/fees</code>
          </p>
        </div>

        <!-- Fee list -->
        <div class="card col-6" id="fees">
          <h2>Fee List</h2>
          <table>
            <thead>
              <tr>
                <th>Fee ID</th>
                <th>Type</th>
                <th>Period</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="feesBody">
              <tr><td colspan="4" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Payment status table -->
        <div class="card col-12" id="status">
          <h2>Student Payment Status (Demo)</h2>
          <table>
            <thead>
              <tr>
                <th>Student ID</th>
                <th>Fee</th>
                <th>Period</th>
                <th>Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="statusBody">
              <tr><td colspan="5" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== AUTH GUARD =====
    const token = localStorage.getItem("token");
    const role = (localStorage.getItem("role") || "").toLowerCase();

    if (!token) window.location.href = "login.html";
    if (role && role !== "department_officer") {
      if (role === "student") window.location.href = "student.html";
      else if (role === "librarian") window.location.href = "librarian.html";
      else if (role === "hall_manager") window.location.href = "hall.html";
      else window.location.href = "login.html";
    }

    const $ = (id) => document.getElementById(id);
    const statusText = $("statusText");

    function setStatus(text){ statusText.textContent = text || ""; }
    function money(n){ return (Number(n)||0).toFixed(0); }
    function badgePaid(status){
      const s = (status || "").toLowerCase();
      if (s === "paid") return `<span class="badge ok">PAID</span>`;
      return `<span class="badge bad">UNPAID</span>`;
    }
    function setModePill(){
      $("modePill").textContent = "Mode: Demo";
    }

    // ===== DEMO STATE =====
    const DEMO = {
      students: [
        { id: "2203177", session: "22" },
        { id: "2203188", session: "22" },
        { id: "2204010", session: "21" },
        { id: "2204500", session: "20" }
      ],
      fees: [
        { id: "DF-2001", type: "Lab Fee", period: "L-2 T-2 (Spring 2026)", amount: 300 }
      ],
      feeRecords: [
        { studentId: "2203177", feeId: "DF-2001", type: "Lab Fee", period: "L-2 T-2 (Spring 2026)", amount: 300, status: "unpaid" },
        { studentId: "2203188", feeId: "DF-2001", type: "Lab Fee", period: "L-2 T-2 (Spring 2026)", amount: 300, status: "paid" }
      ]
    };

    function render(){
      $("studentsCount").textContent = String(DEMO.students.length);
      $("feesCount").textContent = String(DEMO.fees.length);

      const unpaid = DEMO.feeRecords.filter(r => r.status !== "paid").length;
      $("unpaidCount").textContent = String(unpaid);

      const totalDue = DEMO.feeRecords
        .filter(r => r.status !== "paid")
        .reduce((s,r)=> s + (Number(r.amount)||0), 0);
      $("totalDue").textContent = money(totalDue);

      // Fee list
      const feesBody = $("feesBody");
      if (!DEMO.fees.length){
        feesBody.innerHTML = `<tr><td colspan="4" class="muted">No fees created.</td></tr>`;
      } else {
        feesBody.innerHTML = DEMO.fees.map(f => `
          <tr>
            <td>${f.id}</td>
            <td>${f.type}</td>
            <td>${f.period}</td>
            <td>${money(f.amount)}</td>
          </tr>
        `).join("");
      }

      // Payment status
      const statusBody = $("statusBody");
      if (!DEMO.feeRecords.length){
        statusBody.innerHTML = `<tr><td colspan="5" class="muted">No records found.</td></tr>`;
      } else {
        statusBody.innerHTML = DEMO.feeRecords.map(r => `
          <tr>
            <td>${r.studentId}</td>
            <td>${r.type} (${r.feeId})</td>
            <td>${r.period}</td>
            <td>${money(r.amount)}</td>
            <td>${badgePaid(r.status)}</td>
          </tr>
        `).join("");
      }
    }

    // ===== ACTIONS =====
    $("refreshBtn").addEventListener("click", () => {
      setStatus("Refreshed.");
      render();
    });

    $("createFeeBtn").addEventListener("click", () => {
      const type = $("feeType").value;
      const period = $("feePeriod").value.trim();
      const amount = Number($("feeAmount").value || 0);

      if (!period || amount <= 0) {
        setStatus("Please provide Period and valid Amount.");
        return;
      }

      const newId = "DF-" + (2000 + DEMO.fees.length + 1);
      DEMO.fees.unshift({ id: newId, type, period, amount });

      // Assign logic
      const mode = $("assignMode").value;
      let targets = [];

      if (mode === "all") {
        targets = DEMO.students.map(s => s.id);
      } else if (mode === "session") {
        const session = $("assignSession").value.trim();
        if (!session) { setStatus("Please provide a Session."); return; }
        targets = DEMO.students.filter(s => s.session === session).map(s => s.id);
      } else if (mode === "ids") {
        const ids = $("assignIds").value.trim().split(",").map(x=>x.trim()).filter(Boolean);
        if (!ids.length) { setStatus("Please provide Student IDs."); return; }
        targets = ids;
      }

      // Create unpaid records for each target
      targets.forEach(studentId => {
        DEMO.feeRecords.unshift({
          studentId, feeId: newId, type, period, amount, status: "unpaid"
        });
      });

      setStatus(`Department fee created (Demo) and assigned to ${targets.length} students.`);
      render();
    });

    $("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("token");
      localStorage.removeItem("role");
      window.location.href = "login.html";
    });

    setModePill();
    render();
    setStatus("Loaded.");
  </script>
</body>
</html>
